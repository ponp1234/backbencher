<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Question</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <link rel="icon" href="static/logo2.png" type="image/icon type">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gojs/2.2.14/go.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, white 0%, #EEF5FF 100%);
            min-height: 100vh;
            display: flex;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background: #071952;
            backdrop-filter: blur(10px);
            padding: 20px;
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .sidebar-logo h2 {
            color: white;
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .sidebar-logo p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9em;
        }

        .sidebar a {
            display: block;
            padding: 12px 20px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .sidebar a:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateX(5px);
        }

        /* Top Bar Styling */
        .top-bar {
            position: fixed;
            top: 0;
            left: 250px;
            right: 0;
            height: 60px;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .exam-title {
            font-weight: bold;
            color: #071952;
            font-size: 1.2em;
        }

        .question-info {
            color: #071952;
            font-weight: 600;
        }

        .progress-bar {
            width: 300px;
            background-color: #e0e0e0;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50 0%, #2196f3 100%);
            width: {{ (question_number / total_questions) * 100 }}%;
            transition: width 0.5s ease;
            border-radius: 6px;
        }

        .current-time {
            color: #071952;
            font-weight: 600;
            font-family: monospace;
        }

        /* Main Content Styles */
        .question-container {
            flex: 1;
            margin-left: 250px;
            margin-top: 80px;
            display: flex;
            justify-content: center;
            padding: 20px;
            min-height: calc(100vh - 80px);
        }

        .question-box {
            background: white;
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 900px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            animation: fadeInUp 0.6s ease-out;
            position: relative;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .question-number-badge {
            background: linear-gradient(135deg, #071952 0%, #0f3460 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1em;
        }

        .question-type-badge {
            background: #4caf50;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .question-text {
            font-size: 1.4em;
            color: #333;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        /* Answer Options Styling */
        .answer-options {
            margin-bottom: 30px;
        }

        .answer-options label {
            display: block;
            font-size: 1.1em;
            color: #555;
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .answer-options label:hover:not(.disabled) {
            background: #e3f2fd;
            border-color: #2196f3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.2);
        }

        .answer-options label.disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .answer-options input[type="text"],
        .answer-options textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1.1em;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            background: #f8f9fa;
        }

        .answer-options input[type="text"]:focus:not(:disabled),
        .answer-options textarea:focus:not(:disabled) {
            border-color: #2196f3;
            outline: none;
            background: white;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .answer-options input[type="text"]:disabled,
        .answer-options textarea:disabled {
            background: #e9ecef;
            cursor: not-allowed;
        }

        .answer-options input[type="checkbox"],
        .answer-options input[type="radio"] {
            margin-right: 12px;
            transform: scale(1.2);
        }

        .answer-options input[type="checkbox"]:disabled,
        .answer-options input[type="radio"]:disabled {
            cursor: not-allowed;
        }

        /* Button Styling */
        .button-container {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .submit-button, .ai-button, .next-button, .back-button {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
            flex: 1;
        }

        .submit-button {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
        }

        .ai-button {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
        }

        .next-button {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
        }

        .back-button {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
        }

        .submit-button:hover:not(:disabled), 
        .ai-button:hover:not(:disabled), 
        .next-button:hover:not(:disabled), 
        .back-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .submit-button:disabled, 
        .ai-button:disabled, 
        .next-button:disabled {
            background: #cccccc;
            color: #666666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* AI Response Styling */
        .ai-response {
            margin-top: 25px;
            padding: 20px;
            background: linear-gradient(135deg, #f1f8ff 0%, #e3f2fd 100%);
            border-radius: 12px;
            font-size: 1em;
            color: #333;
            display: none;
            border-left: 5px solid #2196f3;
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.1);
        }

        .ai-response-content {
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .ai-response-content p {
            margin: 10px 0;
            line-height: 1.6;
        }

        .ai-response-content strong {
            color: #2196f3;
            display: block;
            margin-top: 15px;
        }

        .ai-hints {
            font-size: 0.95em;
            color: #666;
            background: #e8f5e9;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #4caf50;
        }

        /* Feedback Styling */
        #answer-feedback {
            margin-top: 20px;
            padding: 20px;
            border-radius: 12px;
            font-size: 1.1em;
            animation: fadeIn 0.5s ease-out;
        }

        .feedback-correct {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border: 2px solid #4caf50;
            color: #2e7d32;
        }

        .feedback-incorrect {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border: 2px solid #f44336;
            color: #c62828;
        }

        .feedback-icon {
            font-size: 1.5em;
            margin-right: 10px;
        }

        /* Error Message Styling */
        .error-message {
            color: #d32f2f;
            padding: 10px;
            background: #fde7e7;
            border-radius: 4px;
        }

        .error-message button {
            margin-left: 10px;
            padding: 5px 10px;
            background: #d32f2f;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .error-message button:hover {
            background: #b71c1c;
        }

        /* Question Navigation */
        .question-nav {
            margin-top: 20px;
        }

        .question-nav h3 {
            color: white;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .question-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }

        .question-btn {
            width: 35px;
            height: 35px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .question-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.4);
        }

        .question-btn.current {
            background: #4caf50;
        }

        .question-btn.answered {
            background: #2196f3;
        }

        .question-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Attempted Question Banner */
        .attempted-banner {
            animation: slideIn 0.5s ease-out;
        }

        /* Correct Answer Highlight */
        .correct-answer-highlight {
            background: #e8f5e9 !important;
            border: 2px solid #4caf50 !important;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }

            .top-bar {
                left: 0;
                position: relative;
                height: auto;
                padding: 15px;
                flex-direction: column;
                gap: 10px;
            }

            .question-container {
                margin-left: 0;
                margin-top: 0;
                padding: 15px;
            }

            .question-box {
                padding: 25px;
            }

            .button-container {
                flex-direction: column;
            }

            .progress-bar {
                width: 100%;
            }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2196f3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
    </style>
</head>

<body data-exam-id="{{ exam.id | default(1) }}" 
      data-question-number="{{ question_number | default(1) }}" 
      data-total-questions="{{ total_questions | default(0) }}"
      data-question-type="{{ question.question_type | default('single') }}"
      data-question-attempted="{{ 'true' if question_attempted else 'false' }}"
     data-user-answer="{{ user_answer | tojson | safe if user_answer else '' }}"
      data-is-correct="{{ 'true' if is_correct == true else ('false' if is_correct == false else '') }}"
      data-attempted-questions="{{ attempted_question_ids | tojson | e if attempted_question_ids else '[]' }}">

    <!-- Sidebar Navigation Menu -->
    <div class="sidebar">
        <div class="sidebar-logo">

        </div>

        <div class="question-nav">
            <h3>Questions</h3>
            <div class="question-grid" id="questionGrid">
                <!-- Question navigation buttons will be generated here -->
            </div>
        </div>
        
        <a href="{{ url_for('papers') }}">End Exam</a>
    </div>

    <!-- Top Bar with Exam Title, Question Number, Progress Bar, and Current Time -->
    <div class="top-bar">
        <div class="exam-title">{{ exam.title }}</div>
        <div class="question-info">Question {{ question_number }} of {{ total_questions }}</div>
        <div class="progress-bar">
            <div class="progress-bar-fill"></div>
        </div>
        <div class="current-time" id="current-time"></div>
    </div>

    <div class="question-container">
        <div class="question-box">

            <div class="question-header">
                <div class="question-number-badge">Question {{ question_number }}</div>
                <div class="question-type-badge">{{ question.question_type.upper() }}</div>
            </div>
            
            <!-- Use the |safe filter to allow rendering of HTML content -->
            <div class="question-text" id="question-text">{{ question.question_text | safe }}</div>
            
            <form id="form" method="POST" action="{{ url_for('exam', exam_id=exam.id, question_number=question_number) }}" class="answer-options">
                {% if question.question_type == 'textbox' %}
                    <textarea 
                        class="textbox-answer" 
                        name="textbox_answer" 
                        id="textbox_answer" 
                        placeholder="Type your answer here..."
                        required
                    ></textarea>
                {% elif question.question_type == 'fill_in_the_blank' %}
                    {% for i in range(1, question.blanks + 1) %}
                        <label for="blank{{ i }}">Answer {{ i }}:</label>
                        <input type="text" name="blank{{ i }}" id="blank{{ i }}" required>
                    {% endfor %}
                {% elif question.question_type == 'multiple' %}
                    {% if question.option_a %}
                        <label>
                            <input type="checkbox" name="answer" value="option_a"> {{ question.option_a }}
                        </label>
                    {% endif %}
                    {% if question.option_b %}
                        <label>
                            <input type="checkbox" name="answer" value="option_b"> {{ question.option_b }}
                        </label>
                    {% endif %}
                    {% if question.option_c %}
                        <label>
                            <input type="checkbox" name="answer" value="option_c"> {{ question.option_c }}
                        </label>
                    {% endif %}
                    {% if question.option_d %}
                        <label>
                            <input type="checkbox" name="answer" value="option_d"> {{ question.option_d }}
                        </label>
                    {% endif %}
                {% else %}
                    {% if question.option_a %}
                        <label>
                            <input type="radio" name="answer" value="option_a" required> {{ question.option_a }}
                        </label>
                    {% endif %}
                    {% if question.option_b %}
                        <label>
                            <input type="radio" name="answer" value="option_b"> {{ question.option_b }}
                        </label>
                    {% endif %}
                    {% if question.option_c %}
                        <label>
                            <input type="radio" name="answer" value="option_c"> {{ question.option_c }}
                        </label>
                    {% endif %}
                    {% if question.option_d %}
                        <label>
                            <input type="radio" name="answer" value="option_d"> {{ question.option_d }}
                        </label>
                    {% endif %}
                {% endif %}
                
                <div class="button-container">
                    <button type="button" class="submit-button" id="sb-button" onclick="checkAnswer()">Submit Answer</button>
                    <button type="button" class="next-button" id="next" onclick="submitAnswer()">Next Question</button>
                    <button type="button" class="back-button" onclick="goBack()">Previous</button>
                    <button type="button" class="ai-button" onclick="getAIResponse()" id="ai-button">Ask AI for Help</button>
                </div>
            </form>

            <!-- AI Assistance Response Box -->
            <div class="ai-response" id="ai-response"></div>
        </div>
    </div>

    <!-- JavaScript for the page functionality -->
    <script>
        // Global variables for navigation - safely handle template variables
        const EXAM_DATA = {
            totalQuestions: 0,
            currentQuestion: 0,
            examId: 1
        };

        // Initialize EXAM_DATA safely
        try {
            EXAM_DATA.totalQuestions = parseInt(document.body.dataset.totalQuestions || '0') || 0;
            EXAM_DATA.currentQuestion = (parseInt(document.body.dataset.questionNumber || '1') || 1) - 1;
            EXAM_DATA.examId = parseInt(document.body.dataset.examId || '1') || 1;
        } catch (e) {
            console.error('Error initializing EXAM_DATA:', e);
        }

        // Check if question is already attempted and disable form if so
        function checkQuestionStatus() {
            let questionAttempted = false;
            let userAnswer = null;
            let isCorrect = null;
            
            try {
                // Safely get template variables from data attributes
                questionAttempted = document.body.dataset.questionAttempted === 'true';
                
                const userAnswerData = document.body.dataset.userAnswer;
                if (userAnswerData && userAnswerData !== '' && userAnswerData !== 'null') {
                    userAnswer = JSON.parse(userAnswerData);
                }
                
                const isCorrectData = document.body.dataset.isCorrect;
                if (isCorrectData && isCorrectData !== '') {
                    isCorrect = isCorrectData === 'true';
                }
            } catch (e) {
                console.error('Error parsing question status:', e);
                console.log('Raw data:', {
                    attempted: document.body.dataset.questionAttempted,
                    userAnswer: document.body.dataset.userAnswer,
                    isCorrect: document.body.dataset.isCorrect
                });
            }
            
            if (questionAttempted) {
                // Show "Already Attempted" banner
                showAttemptedBanner();
                
                // Disable all form inputs but keep them visible for review
                disableFormInputs();
                
                // Restore user's previous answer for review
                if (userAnswer) {
                    restoreUserAnswer(userAnswer);
                }
                
                // Show previous result if available
                if (isCorrect !== null) {
                    showQuestionResult(isCorrect);
                }
                
                // Update button states for attempted questions
                updateButtonsForAttemptedQuestion();
            } else {
                // For new questions, disable AI button initially and Next button
                document.getElementById("ai-button").disabled = true;
                document.getElementById("next").disabled = true;
            }
        }
        
        function showAttemptedBanner() {
            const questionBox = document.querySelector('.question-box');
            const attemptedBanner = document.createElement('div');
            attemptedBanner.className = 'attempted-banner';
            attemptedBanner.innerHTML = `
                <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); 
                           padding: 15px; border-radius: 12px; margin-bottom: 25px; 
                           border-left: 5px solid #2196f3; box-shadow: 0 3px 10px rgba(33, 150, 243, 0.2);">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 20px;">📝</span>
                        <div>
                            <strong style="color: #1976d2; font-size: 1.1em;">Already Attempted</strong>
                            <p style="margin: 5px 0 0 0; color: #424242;">
                                You have already submitted your answer for this question. You can review your response and continue to the next question.
                            </p>
                        </div>
                    </div>
                </div>
            `;
            
            // Insert after question header
            const questionHeader = document.querySelector('.question-header');
            questionHeader.parentNode.insertBefore(attemptedBanner, questionHeader.nextSibling);
        }
        
        function disableFormInputs() {
            const inputs = document.querySelectorAll('.answer-options input, .answer-options textarea');
            inputs.forEach(input => {
                input.disabled = true;
                // Add visual indicator for disabled state
                const label = input.closest('label');
                if (label) {
                    label.classList.add('disabled');
                }
            });
        }
        
        function updateButtonsForAttemptedQuestion() {
            const submitButton = document.getElementById("sb-button");
            const nextButton = document.getElementById("next");
            const aiButton = document.getElementById("ai-button");
            
            // Disable submit button and change text
            submitButton.disabled = true;
            submitButton.textContent = "Already Submitted";
            submitButton.style.background = "#95a5a6";
            
            // Enable next button for navigation - use submitAnswer for navigation
            nextButton.disabled = false;
            nextButton.textContent = "Continue to Next";
            nextButton.onclick = function() {
                goToNextQuestion();
            };
            
            // Enable AI button for help/review
            aiButton.disabled = false;
            aiButton.textContent = "Get AI Help";
        }
        
        // Function to navigate to next question
        function goToNextQuestion() {
            const currentQuestionNum = parseInt(document.body.dataset.questionNumber || '1');
            const totalQuestions = parseInt(document.body.dataset.totalQuestions || '1');
            const examId = document.body.dataset.examId || '1';
            
            if (currentQuestionNum < totalQuestions) {
                window.location.href = `/exam/${examId}/${currentQuestionNum + 1}`;
            } else {
                // If this is the last question, go to exam summary
                alert("You have completed all questions! Redirecting to exam summary...");
                window.location.href = `/exam_summary/${examId}`;
            }
        }
        
        function restoreUserAnswer(userAnswer) {
            let questionType = 'single';
            try {
                questionType = document.body.dataset.questionType || 'single';
            } catch (e) {
                console.error('Error getting question type:', e);
            }
            
            try {
                if (questionType === 'single' && userAnswer.answer) {
                    const radio = document.querySelector(`input[value="${userAnswer.answer}"]`);
                    if (radio) {
                        radio.checked = true;
                        // Highlight the selected answer
                        radio.closest('label').style.background = '#e8f4fd';
                        radio.closest('label').style.borderColor = '#2196f3';
                    }
                } else if (questionType === 'multiple' && userAnswer.answers) {
                    userAnswer.answers.forEach(answer => {
                        const checkbox = document.querySelector(`input[value="${answer}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                            // Highlight selected answers
                            checkbox.closest('label').style.background = '#e8f4fd';
                            checkbox.closest('label').style.borderColor = '#2196f3';
                        }
                    });
                } else if (questionType === 'fill_in_the_blank' && userAnswer.answers) {
                    userAnswer.answers.forEach((answer, index) => {
                        const input = document.querySelector(`input[name="blank${index + 1}"]`);
                        if (input) {
                            input.value = answer;
                        }
                    });
                } else if (questionType === 'textbox' && userAnswer.textbox_answer) {
                    const textarea = document.getElementById('textbox_answer');
                    if (textarea) {
                        textarea.value = userAnswer.textbox_answer;
                    }
                }
            } catch (error) {
                console.error('Error restoring user answer:', error);
            }
        }
        
        function showQuestionResult(isCorrect, userAnswer) {
            // Create or update feedback element
            let feedbackDiv = document.getElementById('answer-feedback');
            if (!feedbackDiv) {
                feedbackDiv = document.createElement('div');
                feedbackDiv.id = 'answer-feedback';
                document.querySelector('.question-box').appendChild(feedbackDiv);
            }

            const resultIcon = isCorrect ? '✅' : '❌';
            const resultText = isCorrect ? 'Correct!' : 'Incorrect';
            const resultColor = isCorrect ? '#4caf50' : '#f44336';
            const bgColor = isCorrect ? '#e8f5e9' : '#ffebee';

            // Show what the user submitted
            let submittedAnswerHtml = '';
            if (userAnswer) {
                submittedAnswerHtml = `
                    <div style="margin-top: 15px; padding: 12px; background: rgba(255,255,255,0.7); border-radius: 8px; border-left: 3px solid #2196f3;">
                        <strong style="color: #2196f3;">Your Submitted Answer:</strong>
                        <div style="margin-top: 5px; color: #555;">
                            ${formatUserAnswer(userAnswer)}
                        </div>
                    </div>
                `;
            }

            feedbackDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px; 
                           padding: 20px; margin-top: 20px; border-radius: 12px;
                           background: ${bgColor}; border: 2px solid ${resultColor};
                           animation: fadeIn 0.5s ease-out;">
                    <span style="font-size: 28px;">${resultIcon}</span>
                    <div style="flex: 1;">
                        <strong style="color: ${resultColor}; font-size: 1.3em;">${resultText}</strong>
                        <p style="margin: 5px 0 0 0; color: #555;">
                            ${isCorrect ? 
                                'Great job! Your answer was correct.' : 
                                'Your answer was not correct. Review the material and try to understand the concept better.'}
                        </p>
                        ${submittedAnswerHtml}
                    </div>
                </div>
            `;
        }
        
        // Helper function to format user answer for display
        function formatUserAnswer(userAnswer) {
            const questionType = document.body.dataset.questionType || 'single';
            
            if (questionType === 'single' && userAnswer.answer) {
                // Find the option text for single choice
                const selectedInput = document.querySelector(`input[value="${userAnswer.answer}"]`);
                if (selectedInput) {
                    const label = selectedInput.closest('label');
                    const optionText = label.textContent.trim();
                    return `<span style="font-weight: 600;">${optionText}</span>`;
                }
                return userAnswer.answer;
                
            } else if (questionType === 'multiple' && userAnswer.answers) {
                // Format multiple choice answers
                const selectedOptions = userAnswer.answers.map(answer => {
                    const selectedInput = document.querySelector(`input[value="${answer}"]`);
                    if (selectedInput) {
                        const label = selectedInput.closest('label');
                        return label.textContent.trim();
                    }
                    return answer;
                });
                return `<span style="font-weight: 600;">${selectedOptions.join(', ')}</span>`;
                
            } else if (questionType === 'fill_in_the_blank' && userAnswer.answers) {
                // Format fill in the blank answers
                const answersHtml = userAnswer.answers.map((answer, index) => 
                    `<div><strong>Blank ${index + 1}:</strong> ${answer}</div>`
                ).join('');
                return answersHtml;
                
            } else if (questionType === 'textbox' && userAnswer.textbox_answer) {
                // Format textbox answer
                return `<div style="max-height: 150px; overflow-y: auto; padding: 8px; background: #f5f5f5; border-radius: 4px; font-family: monospace;">${userAnswer.textbox_answer}</div>`;
            }
            
            return JSON.stringify(userAnswer);
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            generateQuestionNavigation();
            updateTime();
            checkQuestionStatus(); // Check if question was already attempted
        });

        // Generate question navigation buttons
        function generateQuestionNavigation() {
            const grid = document.getElementById('questionGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            // Get attempted question IDs from data attribute
            let attemptedQuestions = [];
            try {
                const attemptedData = document.body.dataset.attemptedQuestions;
                if (attemptedData && attemptedData !== '[]' && attemptedData !== '') {
                    attemptedQuestions = JSON.parse(attemptedData);
                }
            } catch (e) {
                console.error('Error parsing attempted questions:', e);
                console.log('Raw attempted data:', document.body.dataset.attemptedQuestions);
                attemptedQuestions = [];
            }
            
            for (let i = 0; i < EXAM_DATA.totalQuestions; i++) {
                const btn = document.createElement('button');
                btn.className = 'question-btn';
                btn.textContent = i + 1;
                
                const questionId = i + 1; // Assuming question IDs are sequential
                
                // Check if this question has been attempted
                if (attemptedQuestions.includes(questionId)) {
                    btn.classList.add('answered');
                    btn.title = 'Question attempted - Click to review';
                } else {
                    btn.title = `Question ${questionId}`;
                }
                
                // Always allow navigation to any question for review purposes
                btn.onclick = () => goToQuestion(i + 1);
                
                if (i === EXAM_DATA.currentQuestion) {
                    btn.classList.add('current');
                }
                
                grid.appendChild(btn);
            }
        }

        // Navigate to specific question
        function goToQuestion(questionNumber) {
            if (questionNumber >= 1 && questionNumber <= EXAM_DATA.totalQuestions) {
                window.location.href = `/exam/${EXAM_DATA.examId}/${questionNumber}`;
            }
        }

        // Update time display
        function updateTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const timeElement = document.getElementById("current-time");
            if (timeElement) {
                timeElement.textContent = `Time: ${hours}:${minutes}:${seconds}`;
            }
        }
        setInterval(updateTime, 1000);

        // Submit answer functionality
        async function submitAnswer() {
            const question = document.getElementById('question-text')?.textContent || '';
            const form = document.querySelector('.answer-options');
            let questionType = 'single';
            
            try {
                questionType = document.body.dataset.questionType || 'single';
            } catch (e) {
                console.error('Error getting question type:', e);
            }

            let payload = { question };

            try {
                if (questionType === "fill_in_the_blank") {
                    const blanks = Array.from(form.querySelectorAll('input[type="text"]'))
                        .map((input) => input.value.trim());
                    payload.answers = blanks;

                } else if (questionType === "multiple") {
                    const selectedOptions = Array.from(form.querySelectorAll('input[type="checkbox"]:checked'))
                        .map((checkbox) => checkbox.value);
                    payload.answers = selectedOptions;

                } else if (questionType === "single") {
                    const selectedOption = form.querySelector('input[type="radio"]:checked');
                    payload.answer = selectedOption ? selectedOption.value : null;
                } else if (questionType === "textbox") {
                    const textAnswer = document.getElementById('textbox_answer');
                    payload.textbox_answer = textAnswer ? textAnswer.value.trim() : '';
                }

                let examId = '1';
                let questionNumber = '1';
                
                try {
                    examId = document.body.dataset.examId || '1';
                    questionNumber = document.body.dataset.questionNumber || '1';
                } catch (e) {
                    console.error('Error getting exam data:', e);
                }
                
                const response = await fetch(`/exam/${examId}/${questionNumber}`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(payload),
                });

                const data = await response.json();
                console.log("Server Response:", data);

                if (response.ok && data.next_question) {
                    window.location.href = `/exam/${examId}/${data.next_question}`;
                } else if (data.message === "Exam completed") {
                    window.location.href = `/exam_summary/${data.session_id}`;
                } else {
                    alert(data.error || "An error occurred while processing your answer.");
                }
            } catch (error) {
                console.error("Error submitting answer:", error);
                alert("Failed to submit your answer. Please try again.");
            }
        }

        // AI Response functionality
        async function getAIResponse() {
            const question = document.getElementById('question-text').textContent;
            const responseBox = document.getElementById('ai-response');
            const form = document.querySelector('.answer-options');
            
            responseBox.style.display = 'block';
            responseBox.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading"></div> Loading AI response...</div>';

            let answerOptions = {};
            
            const blankInputs = form.querySelectorAll('input[type="text"]');
            if (blankInputs.length > 0) {
                answerOptions.type = 'fill_in_the_blank';
                answerOptions.blanks = blankInputs.length;
            } 
            else if (form.querySelector('input[type="checkbox"]')) {
                answerOptions.type = 'multiple';
                answerOptions.options = Array.from(form.querySelectorAll('label')).map(label => ({
                    value: label.querySelector('input').value,
                    text: label.textContent.trim()
                }));
            }
            else if (form.querySelector('input[type="radio"]')) {
                answerOptions.type = 'single';
                answerOptions.options = Array.from(form.querySelectorAll('label')).map(label => ({
                    value: label.querySelector('input').value,
                    text: label.textContent.trim()
                }));
            }
            else if (form.querySelector('textarea')) {
                answerOptions.type = 'textbox';
                answerOptions.description = 'Open-ended text answer';
            }

            try {
                const prompt = {
                    question: question,
                    questionType: answerOptions.type,
                    options: answerOptions.type === 'fill_in_the_blank' ? 
                            `Fill in the blank question with ${answerOptions.blanks} blank(s)` :
                            answerOptions.type === 'textbox' ? 
                            'Open-ended text answer question' :
                            answerOptions.options.map(opt => opt.text).join('\n'),
                    request: "Please analyze this question and provide:\n" +
                            "1. The correct answer or approach\n" +
                            "2. A detailed explanation of why it's correct\n" +
                            "3. Key concepts related to this question\n" +
                            "4. Study tips for this topic"
                };

                const response = await fetch('/ask-ai', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        messages: [{
                            role: 'user',
                            content: JSON.stringify(prompt, null, 2)
                        }]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }
                
                responseBox.innerHTML = `
                    <div class="ai-response-content">
                        <h4 style="color: #2196f3; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                            🤖 AI Assistant Response
                        </h4>
                        <div style="line-height: 1.6;">
                            ${data.response
                                .replace(/\n\n/g, '</p><p>')
                                .replace(/\n/g, '<br>')
                                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                .replace(/^1\./m, '<strong style="color: #4caf50;">✓ Correct Answer:</strong>')
                                .replace(/^2\./m, '<strong style="color: #2196f3;">📚 Explanation:</strong>')
                                .replace(/^3\./m, '<strong style="color: #ff9800;">🎯 Key Concepts:</strong>')
                                .replace(/^4\./m, '<strong style="color: #9c27b0;">💡 Study Tips:</strong>')}
                        </div>
                    </div>
                    <div class="ai-hints" style="margin-top: 15px; font-size: 0.9em; color: #666;">
                        <p>💡 <strong>Tip:</strong> Use this information to understand the concept better. The goal is learning, not just getting the right answer!</p>
                    </div>
                `;
                
            } catch (error) {
                console.error('AI Response Error:', error);
                responseBox.innerHTML = `
                    <div class="error-message" style="color: #d32f2f; padding: 15px; background: #fde7e7; border-radius: 8px; border-left: 4px solid #f44336;">
                        <strong>❌ Error:</strong> ${error.message}
                        <button onclick="getAIResponse()" 
                                style="margin-left: 10px; padding: 8px 15px; background: #d32f2f; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            🔄 Try Again
                        </button>
                    </div>
                `;
            }
        }

        // AI Check for textbox answers
        async function getAICheck() {
            const question = document.getElementById('question-text').textContent;
            const responseBox = document.getElementById('ai-response');
            const userAnswer = document.getElementById('textbox_answer').value.trim();
            
            if (!userAnswer) {
                responseBox.style.display = 'block';
                responseBox.innerHTML = `
                    <div class="error-message" style="color: #ff9800; padding: 15px; background: #fff3e0; border-radius: 8px; border-left: 4px solid #ff9800;">
                        <strong>⚠️ No Answer Provided</strong>
                        <p>Please enter your answer in the text box before asking for AI feedback.</p>
                    </div>
                `;
                return;
            }
            
            responseBox.style.display = 'block';
            responseBox.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading"></div> Analyzing your answer...</div>';

            try {
                const prompt = {
                    question: question,
                    questionType: "textbox",
                    userAnswer: userAnswer,
                    request: "Please analyze the user's answer and provide:\n" +
                            "1. Assessment of the answer's accuracy and completeness\n" +
                            "2. What the user got right\n" +
                            "3. Areas for improvement or missing points\n" +
                            "4. Suggestions for a better answer"
                };

                const response = await fetch('/check-with-ai', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        messages: [{
                            role: 'user',
                            content: JSON.stringify(prompt, null, 2),
                            examId: getExamIdFromUrl(),
                            questionNumber: getQuestionNumberFromUrl()
                        }]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }
                
                responseBox.innerHTML = `
                    <div class="ai-response-content">
                        <h4 style="color: #2196f3; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                            🤖 AI Answer Analysis
                        </h4>
                        <div style="line-height: 1.6;">
                            ${data.response
                                .replace(/\n\n/g, '</p><p>')
                                .replace(/\n/g, '<br>')
                                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                .replace(/^1\./m, '<strong style="color: #4caf50;">📊 Assessment:</strong>')
                                .replace(/^2\./m, '<strong style="color: #2196f3;">✅ Correct Points:</strong>')
                                .replace(/^3\./m, '<strong style="color: #ff9800;">🎯 Areas for Improvement:</strong>')
                                .replace(/^4\./m, '<strong style="color: #9c27b0;">💡 Suggestions:</strong>')}
                        </div>
                    </div>
                    <div class="ai-hints" style="margin-top: 15px; font-size: 0.9em; color: #666;">
                        <p>💡 <strong>Remember:</strong> This feedback is to help you learn and improve your understanding of the topic.</p>
                    </div>
                `;
                
            } catch (error) {
                console.error('AI Response Error:', error);
                responseBox.innerHTML = `
                    <div class="error-message" style="color: #d32f2f; padding: 15px; background: #fde7e7; border-radius: 8px; border-left: 4px solid #f44336;">
                        <strong>❌ Error:</strong> ${error.message}
                        <button onclick="getAICheck()" 
                                style="margin-left: 10px; padding: 8px 15px; background: #d32f2f; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            🔄 Try Again
                        </button>
                    </div>
                `;
            }
        }

        // Check answer functionality
        async function checkAnswer() {
            // Check if question is already attempted
            let questionAttempted = false;
            try {
                questionAttempted = document.body.dataset.questionAttempted === 'true';
            } catch (e) {
                console.error('Error checking question status:', e);
            }
            
            if (questionAttempted) {
                alert("You have already attempted this question. You can review your answer and continue to the next question.");
                return;
            }

            const form = document.querySelector('.answer-options');
            const textboxAnswer = document.getElementById('textbox_answer');
            
            // Validate that an answer is provided
            if (!validateAnswer()) {
                alert("Please provide an answer before submitting.");
                return;
            }

            // Enable navigation buttons after checking
            document.getElementById("ai-button").disabled = false;
            document.getElementById("next").disabled = false;
            
            if (!textboxAnswer) {
                const question = document.querySelector('.question-box');
                let isCorrect = false;

                // Get question type
                const hasTextInputs = form.querySelector('input[type="text"]');
                const hasCheckboxes = form.querySelector('input[type="checkbox"]');
                const hasRadios = form.querySelector('input[type="radio"]');

                // Create feedback element if it doesn't exist
                let feedbackDiv = document.getElementById('answer-feedback');
                if (!feedbackDiv) {
                    feedbackDiv = document.createElement('div');
                    feedbackDiv.id = 'answer-feedback';
                    question.appendChild(feedbackDiv);
                }

                // Show loading state
                feedbackDiv.innerHTML = `
                    <div style="text-align: center; padding: 15px; background: #f5f5f5; border-radius: 8px; margin-top: 15px;">
                        <div class="loading"></div> Checking your answer...
                    </div>
                `;

                try {
                    // Collect user answers based on question type
                    let userAnswers;
                    let questionType;

                    if (hasTextInputs) {
                        // Fill in the blank
                        questionType = 'fill_in_the_blank';
                        userAnswers = {};
                        const inputs = form.querySelectorAll('input[type="text"]');
                        inputs.forEach((input, index) => {
                            userAnswers[`blank${index + 1}`] = input.value.trim();
                        });
                    } else if (hasCheckboxes) {
                        // Multiple choice
                        questionType = 'multiple';
                        userAnswers = Array.from(form.querySelectorAll('input[type="checkbox"]:checked'))
                            .map(cb => cb.value);
                    } else if (hasRadios) {
                        // Single choice
                        questionType = 'single';
                        userAnswers = form.querySelector('input[type="radio"]:checked')?.value;
                    }

                    // Send to server for verification
                    const response = await fetch('/check-answer', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            questionType: questionType,
                            userAnswers: userAnswers,
                            examId: getExamIdFromUrl(),
                            questionNumber: getQuestionNumberFromUrl()
                        })
                    });

                    const result = await response.json();
                    isCorrect = result.isCorrect;

                    // Display feedback with enhanced styling
                    const resultIcon = isCorrect ? '🎉' : '📝';
                    const resultText = isCorrect ? 'Excellent!' : 'Not Quite Right';
                    const resultColor = isCorrect ? '#4caf50' : '#ff9800';
                    const bgColor = isCorrect ? '#e8f5e9' : '#fff3e0';

                    feedbackDiv.innerHTML = `
                        <div style="background: ${bgColor}; border: 2px solid ${resultColor}; 
                                   border-radius: 12px; padding: 20px; margin-top: 20px;
                                   animation: fadeIn 0.5s ease-out;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                                <span style="font-size: 28px;">${resultIcon}</span>
                                <div>
                                    <h3 style="color: ${resultColor}; margin: 0; font-size: 1.3em;">${resultText}</h3>
                                    <p style="margin: 5px 0 0 0; color: #666; font-size: 1em;">
                                        ${isCorrect ? 
                                            'Your answer is correct! Great job understanding this concept.' : 
                                            'Your answer needs some work, but that\'s okay - learning is a process!'}
                                    </p>
                                </div>
                            </div>
                            ${result.explanation ? `<p style="margin-top: 15px; color: #555; font-size: 1em; line-height: 1.5; padding: 10px; background: rgba(255,255,255,0.5); border-radius: 8px;">${result.explanation}</p>` : ''}
                        </div>
                    `;

                    // Disable form inputs after checking
                    disableFormInputs();

                    // Disable submit button after use
                    const submitButton = document.getElementById("sb-button");
                    submitButton.disabled = true;
                    submitButton.textContent = "Answer Submitted";

                    // Style the correct answer(s) if user was wrong
                    if (!isCorrect && result.correctAnswer) {
                        setTimeout(() => highlightCorrectAnswer(result.correctAnswer), 1000);
                    }

                } catch (error) {
                    console.error('Error checking answer:', error);
                    feedbackDiv.innerHTML = `
                        <div style="color: #f44336; background: #ffebee; border: 2px solid #f44336;
                                   border-radius: 8px; padding: 15px; margin-top: 15px;">
                            <strong>❌ Error checking answer.</strong>
                            <p style="margin: 5px 0 0 0;">Please try again or continue to the next question.</p>
                        </div>
                    `;
                }
                
            } else {
                // For textbox questions, use AI check
                getAICheck();
                // Also disable submit button for textbox questions
                const submitButton = document.getElementById("sb-button");
                submitButton.disabled = true;
                submitButton.textContent = "Answer Submitted";
                
                // Disable the textbox
                textboxAnswer.disabled = true;
            }
        }

        // Validate that user has provided an answer
        function validateAnswer() {
            const form = document.querySelector('.answer-options');
            let questionType = 'single';
            
            try {
                questionType = document.body.dataset.questionType || 'single';
            } catch (e) {
                console.error('Error getting question type:', e);
            }

            if (questionType === 'textbox') {
                const textarea = document.getElementById('textbox_answer');
                return textarea && textarea.value.trim() !== '';
            } else if (questionType === 'fill_in_the_blank') {
                const inputs = form.querySelectorAll('input[type="text"]');
                return Array.from(inputs).every(input => input.value.trim() !== '');
            } else if (questionType === 'multiple') {
                return form.querySelector('input[type="checkbox"]:checked') !== null;
            } else if (questionType === 'single') {
                return form.querySelector('input[type="radio"]:checked') !== null;
            }
            return true;
        }

        // Helper function to highlight correct answer
        function highlightCorrectAnswer(correctAnswer) {
            const form = document.querySelector('.answer-options');
            
            if (Array.isArray(correctAnswer)) {
                // Multiple correct answers
                correctAnswer.forEach(answer => {
                    const input = form.querySelector(`input[value="${answer}"]`);
                    if (input) {
                        const label = input.closest('label');
                        label.classList.add('correct-answer-highlight');
                        label.innerHTML = `<span style="color: #4caf50;">✓</span> ${label.textContent}`;
                    }
                });
            } else {
                // Single correct answer
                const input = form.querySelector(`input[value="${correctAnswer}"]`);
                if (input) {
                    const label = input.closest('label');
                    label.classList.add('correct-answer-highlight');
                    label.innerHTML = `<span style="color: #4caf50;">✓</span> ${label.textContent}`;
                }
            }
        }

        // Helper functions to get exam ID and question number from URL
        function getExamIdFromUrl() {
            const pathParts = window.location.pathname.split('/');
            return pathParts[pathParts.length - 2];
        }

        function getQuestionNumberFromUrl() {
            const pathParts = window.location.pathname.split('/');
            return pathParts[pathParts.length - 1];
        }

        // Navigation functions
        function goBack() {
            window.history.back();
        }
    </script>

</body>
</html>