<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P4 Science Term 3 Review Exam</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gojs/2.2.14/go.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, white 0%, #EEF5FF 100%);
            min-height: 100vh;
            display: flex;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background: #071952;
            backdrop-filter: blur(10px);
            padding: 20px;
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .sidebar-logo h2 {
            color: white;
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .sidebar-logo p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9em;
        }

        .sidebar a {
            display: block;
            padding: 12px 20px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .sidebar a:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateX(5px);
        }

        .question-nav {
            margin-top: 20px;
        }

        .question-nav h3 {
            color: white;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .question-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }

        .question-btn {
            width: 35px;
            height: 35px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .question-btn:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .question-btn.current {
            background: #4caf50;
        }

        .question-btn.answered {
            background: #2196f3;
        }

        /* Top Bar Styling */
        .top-bar {
            position: fixed;
            top: 0;
            left: 250px;
            right: 0;
            height: 60px;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .exam-title {
            font-weight: bold;
            color: #071952;
            font-size: 1.2em;
        }

        .question-info {
            color: #071952;
            font-weight: 600;
        }

        .progress-bar {
            width: 300px;
            background-color: #e0e0e0;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50 0%, #2196f3 100%);
            transition: width 0.5s ease;
            border-radius: 6px;
        }

        .current-time {
            color: #071952;
            font-weight: 600;
            font-family: monospace;
        }

        /* Main Content Styles */
        .question-container {
            flex: 1;
            margin-left: 250px;
            margin-top: 80px;
            display: flex;
            justify-content: center;
            padding: 20px;
            min-height: calc(100vh - 80px);
        }

        .question-box {
            background: white;
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 900px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            animation: fadeInUp 0.6s ease-out;
            position: relative;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .question-number-badge {
            background: linear-gradient(135deg, #071952 0%, #0f3460 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1em;
        }

        .question-type-badge {
            background: #4caf50;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .question-text {
            font-size: 1.4em;
            color: #333;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        /* Enhanced Table Styles */
        .classification-table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .classification-table th {
            background: linear-gradient(135deg, #071952 0%, #0f3460 100%);
            color: white;
            padding: 18px;
            text-align: center;
            font-weight: 600;
            font-size: 1.1em;
        }

        .classification-table td {
            padding: 15px 18px;
            text-align: center;
            border-bottom: 1px solid #f0f0f0;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

        .classification-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .classification-table tr:hover {
            background: #e3f2fd;
        }

        .light-source {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%) !important;
            color: #856404;
            font-weight: 600;
        }

        .non-light-source {
            background: linear-gradient(135deg, #d1ecf1 0%, #74b9ff 100%) !important;
            color: #0c5460;
            font-weight: 600;
        }

        /* Enhanced Diagram Styles */
        .diagram-container {
            text-align: center;
            margin: 25px 0;
            padding: 25px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }

        .thermometer {
            width: 70px;
            height: 220px;
            background: linear-gradient(to top, #dc3545 0%, #dc3545 65%, #f8f9fa 65%, #f8f9fa 100%);
            border: 4px solid #333;
            border-radius: 35px 35px 15px 15px;
            margin: 0 auto;
            position: relative;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .thermometer::before {
            content: '';
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 35px;
            height: 35px;
            background: #dc3545;
            border-radius: 50%;
            border: 4px solid #333;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }

        .temperature-scale {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 220px;
            margin-left: 25px;
            font-weight: bold;
            font-size: 1.1em;
        }

        .graph-container {
            background: white;
            border: 3px solid #333;
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .light-graph {
            width: 100%;
            height: 200px;
            background: linear-gradient(to right, 
                #333 0%, #333 10%, #fff 10%, #fff 15%,
                #333 15%, #333 25%, #fff 25%, #fff 30%,
                #333 30%, #333 40%, #fff 40%, #fff 45%,
                #333 45%, #333 55%, #fff 55%, #fff 60%,
                #333 60%, #333 70%, #fff 70%, #fff 100%);
            border: 2px solid #333;
            position: relative;
            border-radius: 8px;
        }

        .time-axis {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            font-weight: bold;
            font-size: 1em;
        }

        /* Answer Options Styling */
        .answer-options {
            margin-bottom: 30px;
        }

        .answer-options label {
            display: block;
            font-size: 1.1em;
            color: #555;
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .answer-options label:hover {
            background: #e3f2fd;
            border-color: #2196f3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.2);
        }

        .answer-options input[type="text"],
        .answer-options textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1.1em;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            background: #f8f9fa;
        }

        .answer-options input[type="text"]:focus,
        .answer-options textarea:focus {
            border-color: #2196f3;
            outline: none;
            background: white;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .answer-options input[type="checkbox"],
        .answer-options input[type="radio"] {
            margin-right: 12px;
            transform: scale(1.2);
        }

        /* Button Styling */
        .button-container {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .submit-button, .ai-button, .next-button, .back-button {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .submit-button {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            flex: 1;
        }

        .ai-button {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            flex: 1;
        }

        .next-button {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            flex: 1;
        }

        .back-button {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
            flex: 1;
        }

        .submit-button:hover, .ai-button:hover, .next-button:hover, .back-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .submit-button:disabled, .ai-button:disabled, .next-button:disabled {
            background: #cccccc;
            color: #666666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* AI Response Styling */
        .ai-response {
            margin-top: 25px;
            padding: 20px;
            background: linear-gradient(135deg, #f1f8ff 0%, #e3f2fd 100%);
            border-radius: 12px;
            font-size: 1em;
            color: #333;
            display: none;
            border-left: 5px solid #2196f3;
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.1);
        }

        .ai-response-content {
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .ai-response-content p {
            margin: 10px 0;
            line-height: 1.6;
        }

        .ai-response-content strong {
            color: #2196f3;
            display: block;
            margin-top: 15px;
        }

        .ai-hints {
            font-size: 0.95em;
            color: #666;
            background: #e8f5e9;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #4caf50;
        }

        /* Feedback Styling */
        #answer-feedback {
            margin-top: 20px;
            padding: 20px;
            border-radius: 12px;
            font-size: 1.1em;
            animation: fadeIn 0.5s ease-out;
        }

        .feedback-correct {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border: 2px solid #4caf50;
            color: #2e7d32;
        }

        .feedback-incorrect {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border: 2px solid #f44336;
            color: #c62828;
        }

        .feedback-icon {
            font-size: 1.5em;
            margin-right: 10px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }

            .top-bar {
                left: 0;
                position: relative;
                height: auto;
                padding: 15px;
                flex-direction: column;
                gap: 10px;
            }

            .question-container {
                margin-left: 0;
                margin-top: 0;
                padding: 15px;
            }

            .question-box {
                padding: 25px;
            }

            .button-container {
                flex-direction: column;
            }

            .progress-bar {
                width: 100%;
            }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2196f3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>

<body>
    <!-- Sidebar Navigation Menu -->
    <div class="sidebar">
        <div class="sidebar-logo">
            <h2>🔬 P4 Science</h2>
            <p>Term 3 Review Exam</p>
        </div>
        
        <div class="question-nav">
            <h3>Questions</h3>
            <div class="question-grid" id="questionGrid">
                <!-- Question navigation buttons will be generated here -->
            </div>
        </div>
        
        <a href="#" onclick="endExam()">📋 End Exam</a>
        <a href="#" onclick="showResults()">📊 View Results</a>
    </div>

    <!-- Top Bar with Exam Title, Question Number, Progress Bar, and Current Time -->
    <div class="top-bar">
        <div class="exam-title">P4 Science Term 3 Review</div>
        <div class="question-info" id="questionInfo">Question 1 of 15</div>
        <div class="progress-bar">
            <div class="progress-bar-fill" id="progressBarFill"></div>
        </div>
        <div class="current-time" id="current-time"></div>
    </div>

    <div class="question-container">
        <div class="question-box">
            <div class="question-header">
                <div class="question-number-badge" id="questionNumberBadge">Question 1</div>
                <div class="question-type-badge" id="questionTypeBadge">MCQ - Section A</div>
            </div>
            
            <div class="question-text" id="question-text">
                <!-- Question content will be loaded here -->
            </div>
            
            <form class="answer-options" id="answerForm">
                <!-- Answer options will be generated here -->
            </form>

            <div class="button-container">
                <button type="button" class="submit-button" id="submitButton" onclick="checkAnswer()">
                    Check Answer
                </button>
                <button type="button" class="ai-button" id="aiButton" onclick="getAIResponse()" disabled>
                    Ask AI for Help
                </button>
                <button type="button" class="next-button" id="nextButton" onclick="nextQuestion()" disabled>
                    Next Question
                </button>
                <button type="button" class="back-button" id="backButton" onclick="previousQuestion()">
                    Previous
                </button>
            </div>

            <!-- AI Assistance Response Box -->
            <div class="ai-response" id="ai-response"></div>
            
            <!-- Answer Feedback -->
            <div id="answer-feedback"></div>
        </div>
    </div>

    <script>
        // Exam data with all 15 questions
        const examData = {
            id: 1,
            title: "P4 Science Term 3 Review",
            totalQuestions: 15,
            questions: [
                {
                    id: 1,
                    section: "A",
                    type: "single",
                    question: "Study the classification table of light sources and non-light sources below:",
                    additionalContent: `
                        <table class="classification-table">
                            <thead>
                                <tr>
                                    <th colspan="2">Classification of Objects</th>
                                </tr>
                                <tr>
                                    <th>Light Sources</th>
                                    <th>Non-Light Sources</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="light-source">Sun</td>
                                    <td class="non-light-source">Moon</td>
                                </tr>
                                <tr>
                                    <td class="light-source">Firefly</td>
                                    <td class="non-light-source">Mirror</td>
                                </tr>
                                <tr>
                                    <td class="light-source">Lightning</td>
                                    <td class="non-light-source">Battery</td>
                                </tr>
                                <tr>
                                    <td class="light-source">Highlighter</td>
                                    <td class="non-light-source">Book</td>
                                </tr>
                            </tbody>
                        </table>
                        <p><strong>Which of the following has/have been classified wrongly?</strong></p>
                    `,
                    option_a: "Firefly only",
                    option_b: "Firefly and Moon only", 
                    option_c: "Lightning and Battery only",
                    option_d: "Firefly and Highlighter only",
                    correct_option: "option_d",
                    explanation: "Firefly produces its own light through bioluminescence (correct as light source). The Moon reflects sunlight but doesn't produce its own light (correctly classified as non-light source). Lightning produces light through electrical discharge (correct as light source). However, a Highlighter does NOT produce its own light - it only reflects light, so it should be classified as a non-light source. A Battery stores electrical energy but doesn't produce light by itself (correctly classified as non-light source).",
                    marks: 1
                },
                {
                    id: 2,
                    section: "A", 
                    type: "single",
                    question: "The glass can be seen because it ________.",
                    option_a: "is opaque",
                    option_b: "reflects light",
                    option_c: "absorbs light", 
                    option_d: "is a source of light",
                    correct_option: "option_b",
                    explanation: "We can see glass because it reflects some light back to our eyes. Even though glass is mostly transparent (allows light to pass through), it still reflects a small amount of light from its surface, which is why we can see the glass itself. If glass absorbed all light, it would appear black. If it were opaque, no light would pass through it.",
                    marks: 1
                },
                {
                    id: 3,
                    section: "A",
                    type: "single", 
                    question: "Which of the following is NOT a source of heat?",
                    option_a: "A jacket",
                    option_b: "Fire",
                    option_c: "A cup of hot tea",
                    option_d: "The Sun",
                    correct_option: "option_a",
                    explanation: "A jacket is NOT a source of heat. It is an insulator that helps trap and retain body heat, preventing heat loss to the environment. Fire produces heat through combustion, hot tea contains thermal energy and can transfer heat, and the Sun produces enormous amounts of heat through nuclear fusion. The jacket itself doesn't generate heat - it only helps conserve the heat your body produces.",
                    marks: 1
                },
                {
                    id: 4,
                    section: "A",
                    type: "single",
                    question: "A light sensor counts objects passing on a moving belt. Study the light graph below:",
                    additionalContent: `
                        <div class="graph-container">
                            <div class="light-graph"></div>
                            <div class="time-axis">
                                <span>0s</span>
                                <span>3s</span>
                                <span>6s</span>
                                <span>9s</span>
                                <span>12s</span>
                                <span>15s</span>
                                <span>18s</span>
                            </div>
                            <p style="margin-top: 15px; font-weight: bold;">Dark areas = object blocking light sensor</p>
                        </div>
                        <p><strong>How many objects passed the sensor in 18 seconds?</strong></p>
                    `,
                    option_a: "4",
                    option_b: "5", 
                    option_c: "9",
                    option_d: "18",
                    correct_option: "option_a",
                    explanation: "Looking at the light graph, we can count the dark areas (where objects block the light sensor). Each dark area represents one object passing by. Counting from left to right: 1st object (0-2s), 2nd object (3-5s), 3rd object (6-8s), and 4th object (9-11s). Therefore, 4 objects passed the sensor in 18 seconds.",
                    marks: 1
                },
                {
                    id: 5,
                    section: "A",
                    type: "single",
                    question: "A bottle of milk at 30°C was placed in water. After two minutes, the milk reached 50°C. What was the likely temperature of the water at first?",
                    option_a: "10°C",
                    option_b: "30°C", 
                    option_c: "50°C",
                    option_d: "80°C",
                    correct_option: "option_d",
                    explanation: "Heat always flows from a hotter object to a cooler object. Since the milk temperature increased from 30°C to 50°C, heat must have flowed from the water to the milk. This means the water was initially hotter than 30°C. For the milk to reach 50°C, the water temperature must have been significantly higher than 50°C initially. 80°C is the most reasonable answer as it would provide enough thermal energy to heat the milk to 50°C.",
                    marks: 1
                },
                {
                    id: 6,
                    section: "A",
                    type: "single",
                    question: "Betty measured her shadow length from a lamp post at different times. Her shadow length decreased steadily over time. Which best describes Betty's position during the experiment?",
                    option_a: "Betty stood still near the lamp post",
                    option_b: "Betty moved towards the lamp post",
                    option_c: "Betty moved away from the lamp post", 
                    option_d: "Betty moved towards then away from the lamp post",
                    correct_option: "option_b",
                    explanation: "When Betty moves closer to the lamp post (light source), her shadow becomes shorter. This is because the angle between the light rays and her body becomes steeper, creating a smaller shadow. If she moved away, her shadow would become longer. Since her shadow decreased steadily, she must have been moving towards the lamp post consistently.",
                    marks: 1
                },
                {
                    id: 7,
                    section: "A", 
                    type: "single",
                    question: "A torch shines on a wooden block placed in front of a screen. Which image would appear on the screen?",
                    additionalContent: `
                        <div class="diagram-container">
                            <p><strong>Setup:</strong> Torch → Wooden Block → Screen</p>
                            <div style="display: flex; justify-content: space-around; margin: 20px 0; align-items: center;">
                                <div style="text-align: center;">
                                    <div style="width: 60px; height: 40px; background: linear-gradient(135deg, #ffd700, #ffed4e); border: 2px solid #333; margin: 0 auto; border-radius: 8px;"></div>
                                    <p style="margin-top: 8px; font-weight: bold;">Torch</p>
                                </div>
                                <div style="text-align: center;">
                                    <div style="width: 40px; height: 60px; background: linear-gradient(135deg, #8B4513, #A0522D); border: 2px solid #333; margin: 0 auto; border-radius: 8px;"></div>
                                    <p style="margin-top: 8px; font-weight: bold;">Wooden Block</p>
                                </div>
                                <div style="text-align: center;">
                                    <div style="width: 80px; height: 100px; background: linear-gradient(135deg, #f0f0f0, #e0e0e0); border: 2px solid #333; margin: 0 auto; border-radius: 8px;"></div>
                                    <p style="margin-top: 8px; font-weight: bold;">Screen</p>
                                </div>
                            </div>
                        </div>
                    `,
                    option_a: "A bright rectangle matching the block's shape",
                    option_b: "A dark shadow matching the block's shape", 
                    option_c: "No image would appear",
                    option_d: "A blurred image of the torch",
                    correct_option: "option_b",
                    explanation: "When light from the torch hits the opaque wooden block, the block prevents light from reaching certain areas of the screen behind it. This creates a shadow - a dark area on the screen that matches the shape of the wooden block. The shadow appears because the block blocks the light rays from reaching that part of the screen.",
                    marks: 1
                },
                {
                    id: 8,
                    section: "B",
                    type: "fill_in_the_blank",
                    question: "John has a fever. Study the thermometer reading below:",
                    additionalContent: `
                        <div class="diagram-container">
                            <div style="display: flex; justify-content: center; align-items: center; gap: 30px;">
                                <div class="thermometer"></div>
                                <div class="temperature-scale">
                                    <span>42°C</span>
                                    <span>40°C</span>
                                    <span style="color: #dc3545; font-weight: bold; font-size: 1.2em;">39°C ←</span>
                                    <span>38°C</span>
                                    <span>36°C</span>
                                    <span>34°C</span>
                                </div>
                            </div>
                        </div>
                        <p><strong>(a) State the temperature reading shown on the thermometer.</strong></p>
                    `,
                    blanks: 1,
                    correct_options: ["39°C", "39", "39 degrees", "39 degrees celsius", "thirty-nine degrees celsius"],
                    explanation: "The thermometer shows a reading of 39°C. The red mercury/liquid level reaches the 39°C mark on the scale. This indicates John has a fever, as normal body temperature is around 37°C.",
                    marks: 1
                },
                {
                    id: 9,
                    section: "B",
                    type: "fill_in_the_blank", 
                    question: "(b) Name the instrument used to measure his body temperature.",
                    blanks: 1,
                    correct_options: ["Thermometer", "clinical thermometer", "medical thermometer", "digital thermometer"],
                    explanation: "A thermometer is the instrument used to measure body temperature. Clinical thermometers are specifically designed to measure human body temperature and typically have a range suitable for body temperature measurements (around 35°C to 42°C).",
                    marks: 1
                },
                {
                    id: 10,
                    section: "B",
                    type: "textbox",
                    question: "(c) What happens to his body temperature after placing a cold wet towel on his forehead? Explain your answer.",
                    correct_options: ["His body temperature decreases because heat flows from his warm body to the cold towel", "temperature decreases", "it decreases because body loses heat to the cold towel", "decreases due to heat transfer from body to towel", "goes down because heat moves from hot body to cold towel"],
                    explanation: "His body temperature decreases because heat always flows from a warmer object to a cooler object. The cold wet towel absorbs heat from John's warm body through conduction, helping to lower his body temperature. The evaporation of water from the wet towel also helps cool the body further.",
                    marks: 2
                },
                {
                    id: 11,
                    section: "B",
                    type: "single",
                    question: "Mike wants to defrost frozen vegetables quickly. Study the four different setups below:",
                    additionalContent: `
                        <table class="classification-table">
                            <thead>
                                <tr>
                                    <th>Setup</th>
                                    <th>Container</th>
                                    <th>Water Amount</th>
                                    <th>Water Temperature</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>A</strong></td>
                                    <td>Small bowl</td>
                                    <td>Little water</td>
                                    <td>Cold (10°C)</td>
                                </tr>
                                <tr>
                                    <td><strong>B</strong></td>
                                    <td>Small bowl</td>
                                    <td>Little water</td>
                                    <td>Hot (60°C)</td>
                                </tr>
                                <tr>
                                    <td><strong>C</strong></td>
                                    <td>Large bowl</td>
                                    <td>Lots of water</td>
                                    <td>Cold (10°C)</td>
                                </tr>
                                <tr>
                                    <td><strong>D</strong></td>
                                    <td>Large bowl</td>
                                    <td>Lots of water</td>
                                    <td>Hot (60°C)</td>
                                </tr>
                            </tbody>
                        </table>
                        <p><strong>Which setup should Mike use to defrost the vegetables most quickly? Explain your answer.</strong></p>
                    `,
                    option_a: "Setup A - Small bowl with little cold water",
                    option_b: "Setup B - Small bowl with little hot water",
                    option_c: "Setup C - Large bowl with lots of cold water", 
                    option_d: "Setup D - Large bowl with lots of hot water",
                    correct_option: "option_d",
                    explanation: "Setup D is the best choice because it has the most hot water. Hot water transfers heat to the frozen vegetables much faster than cold water. Having lots of hot water means there's more thermal energy available to melt the ice, and the large amount of water ensures the temperature won't drop quickly as heat is transferred to the vegetables. This combination of high temperature and large quantity provides the fastest defrosting.",
                    marks: 2
                },
                {
                    id: 12,
                    section: "B",
                    type: "fill_in_the_blank",
                    question: "Mandy investigates how the distance 'd' from a light source affects the height of a shadow. Study her results:",
                    additionalContent: `
                        <table class="classification-table">
                            <thead>
                                <tr>
                                    <th>Distance 'd' (cm)</th>
                                    <th>Height of Shadow (cm)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>2</td><td>35</td></tr>
                                <tr><td>4</td><td>25</td></tr>
                                <tr><td>6</td><td>20</td></tr>
                                <tr><td>8</td><td>?</td></tr>
                            </tbody>
                        </table>
                        <p><strong>(a) State the relationship between distance 'd' and the height of the shadow.</strong></p>
                    `,
                    blanks: 1,
                    correct_options: ["As distance d increases, the height of shadow decreases", "inverse relationship", "as distance increases, shadow height decreases", "distance increases, shadow gets smaller", "the further the distance, the shorter the shadow"],
                    explanation: "There is an inverse relationship between distance and shadow height. As the distance 'd' increases, the height of the shadow decreases. This happens because when the object is moved further from the light source, the light rays spread out more, creating a smaller shadow.",
                    marks: 1
                },
                {
                    id: 13,
                    section: "B", 
                    type: "fill_in_the_blank",
                    question: "(b) Predict the height of the shadow when d = 8 cm.",
                    blanks: 1,
                    correct_options: ["18 cm", "17 cm", "18", "17", "19 cm", "19", "between 17-19 cm"],
                    explanation: "Following the pattern in the data: at d=2cm, height=35cm; at d=4cm, height=25cm (decrease of 10cm); at d=6cm, height=20cm (decrease of 5cm). The rate of decrease is slowing down. Following this trend, at d=8cm, the height would be approximately 18cm (decrease of about 2cm from the previous reading).",
                    marks: 1
                },
                {
                    id: 14,
                    section: "B",
                    type: "textbox", 
                    question: "(c) Explain why a dark shadow is still formed when a piece of clear glass is placed between the light source and the object.",
                    correct_options: ["Clear glass is transparent and allows most light to pass through, so the object still blocks light and creates a shadow", "glass is transparent so light passes through", "clear glass lets light through so object still blocks light", "glass doesn't block light so shadow still forms", "transparent glass allows light to reach the object"],
                    explanation: "Clear glass is transparent, which means it allows most light to pass through it without blocking it. Since the light can still travel through the glass and reach the object, the object can still block this light and create a shadow on the screen. The glass doesn't interfere with the shadow formation because it doesn't significantly reduce the amount of light reaching the object.",
                    marks: 2
                },
                {
                    id: 15,
                    section: "B",
                    type: "single",
                    question: "Dan wants to choose a curtain material that will block the most light from entering his room. He tests four different materials by shining a torch through them. Study his results:",
                    additionalContent: `
                        <table class="classification-table">
                            <thead>
                                <tr>
                                    <th>Material</th>
                                    <th>Amount of Light Passing Through</th>
                                    <th>Property</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Material A</strong></td>
                                    <td>Most light passes through</td>
                                    <td>Transparent</td>
                                </tr>
                                <tr>
                                    <td><strong>Material B</strong></td>
                                    <td>No light passes through</td>
                                    <td>Opaque</td>
                                </tr>
                                <tr>
                                    <td><strong>Material C</strong></td>
                                    <td>Some light passes through</td>
                                    <td>Translucent</td>
                                </tr>
                                <tr>
                                    <td><strong>Material D</strong></td>
                                    <td>Little light passes through</td>
                                    <td>Nearly opaque</td>
                                </tr>
                            </tbody>
                        </table>
                        <p><strong>Which material should Dan choose and why?</strong></p>
                    `,
                    option_a: "Material A - because it's transparent",
                    option_b: "Material B - because it blocks all light",
                    option_c: "Material C - because it's translucent", 
                    option_d: "Material D - because it's nearly opaque",
                    correct_option: "option_b",
                    explanation: "Dan should choose Material B because it is opaque and blocks all light from passing through. Since Dan wants to block the MOST light from entering his room, Material B is the best choice as it allows NO light to pass through. Material A would be the worst choice as it lets most light through, while Materials C and D would still allow some light to enter the room.",
                    marks: 2
                }
            ]
        };

        // Exam state
        let currentQuestion = 0;
        let userAnswers = [];
        let score = 0;
        let startTime = Date.now();
        let examResults = [];

        // Initialize exam
        function initializeExam() {
            generateQuestionNavigation();
            displayQuestion(currentQuestion);
            updateProgress();
            updateControls();
            updateTime();
            setInterval(updateTime, 1000);
        }

        // Generate question navigation buttons
        function generateQuestionNavigation() {
            const grid = document.getElementById('questionGrid');
            grid.innerHTML = '';
            
            for (let i = 0; i < examData.totalQuestions; i++) {
                const btn = document.createElement('button');
                btn.className = 'question-btn';
                btn.textContent = i + 1;
                btn.onclick = () => goToQuestion(i);
                
                if (i === currentQuestion) {
                    btn.classList.add('current');
                }
                if (userAnswers[i] !== undefined) {
                    btn.classList.add('answered');
                }
                
                grid.appendChild(btn);
            }
        }

        // Go to specific question
        function goToQuestion(index) {
            if (index >= 0 && index < examData.totalQuestions) {
                currentQuestion = index;
                displayQuestion(currentQuestion);
                updateProgress();
                updateControls();
                generateQuestionNavigation();
            }
        }

        // Display current question
        function displayQuestion(index) {
            const question = examData.questions[index];
            
            // Update question header
            document.getElementById('questionNumberBadge').textContent = `Question ${index + 1}`;
            document.getElementById('questionTypeBadge').textContent = `${question.type.toUpperCase()} - Section ${question.section}`;
            document.getElementById('questionInfo').textContent = `Question ${index + 1} of ${examData.totalQuestions}`;
            
            // Update question text
            let questionHtml = question.question;
            if (question.additionalContent) {
                questionHtml += question.additionalContent;
            }
            document.getElementById('question-text').innerHTML = questionHtml;
            
            // Generate answer options
            const form = document.getElementById('answerForm');
            form.innerHTML = '';
            
            if (question.type === 'single') {
                // Single choice (radio buttons)
                ['option_a', 'option_b', 'option_c', 'option_d'].forEach(optionKey => {
                    if (question[optionKey]) {
                        const label = document.createElement('label');
                        label.innerHTML = `
                            <input type="radio" name="answer" value="${optionKey}" ${userAnswers[index] === optionKey ? 'checked' : ''}>
                            ${question[optionKey]}
                        `;
                        form.appendChild(label);
                    }
                });
            } else if (question.type === 'fill_in_the_blank') {
                // Fill in the blank
                for (let i = 1; i <= question.blanks; i++) {
                    const label = document.createElement('label');
                    label.innerHTML = `Answer ${i}:`;
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.name = `blank${i}`;
                    input.id = `blank${i}`;
                    input.required = true;
                    input.value = userAnswers[index] && userAnswers[index][`blank${i}`] ? userAnswers[index][`blank${i}`] : '';
                    
                    form.appendChild(label);
                    form.appendChild(input);
                }
            } else if (question.type === 'textbox') {
                // Textbox answer
                const textarea = document.createElement('textarea');
                textarea.className = 'textbox-answer';
                textarea.name = 'textbox_answer';
                textarea.id = 'textbox_answer';
                textarea.placeholder = 'Type your answer here...';
                textarea.required = true;
                textarea.style.minHeight = '120px';
                textarea.value = userAnswers[index] || '';
                form.appendChild(textarea);
            }
            
            // Clear previous feedback
            const feedbackDiv = document.getElementById('answer-feedback');
            feedbackDiv.innerHTML = '';
            
            // Reset AI response
            document.getElementById('ai-response').style.display = 'none';
            
            updateControls();
        }

        // Update progress bar and navigation
        function updateProgress() {
            const progress = ((currentQuestion + 1) / examData.totalQuestions) * 100;
            document.getElementById('progressBarFill').style.width = progress + '%';
            generateQuestionNavigation();
        }

        // Update control buttons
        function updateControls() {
            const submitBtn = document.getElementById('submitButton');
            const aiBtn = document.getElementById('aiButton');
            const nextBtn = document.getElementById('nextButton');
            const backBtn = document.getElementById('backButton');
            
            // Check if question is answered
            const isAnswered = userAnswers[currentQuestion] !== undefined;
            
            submitBtn.disabled = false;
            aiBtn.disabled = true;
            nextBtn.disabled = !isAnswered;
            backBtn.disabled = currentQuestion === 0;
            
            if (currentQuestion === examData.totalQuestions - 1) {
                nextBtn.textContent = 'Finish Exam';
            } else {
                nextBtn.textContent = 'Next Question';
            }
        }

        // Update current time
        function updateTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            document.getElementById("current-time").textContent = `${hours}:${minutes}:${seconds}`;
        }

        // Check answer function
        async function checkAnswer() {
            const question = examData.questions[currentQuestion];
            const form = document.getElementById('answerForm');
            let userAnswer;
            let isCorrect = false;

            // Get user answer based on question type
            if (question.type === 'single') {
                const selectedOption = form.querySelector('input[type="radio"]:checked');
                userAnswer = selectedOption ? selectedOption.value : null;
                isCorrect = userAnswer === question.correct_option;
            } else if (question.type === 'fill_in_the_blank') {
                userAnswer = {};
                for (let i = 1; i <= question.blanks; i++) {
                    const input = form.querySelector(`#blank${i}`);
                    userAnswer[`blank${i}`] = input ? input.value.trim() : '';
                }
                // Check if any of the correct options match
                const userAnswerText = Object.values(userAnswer).join(' ').toLowerCase().trim();
                isCorrect = question.correct_options.some(correct => 
                    userAnswerText === correct.toLowerCase().trim()
                );
            } else if (question.type === 'textbox') {
                const textarea = form.querySelector('#textbox_answer');
                userAnswer = textarea ? textarea.value.trim() : '';
                
                // Use AI to check textbox answers
                if (userAnswer) {
                    try {
                        const aiResult = await checkAnswerWithAI(question.question, userAnswer, question.correct_options);
                        isCorrect = aiResult.isCorrect;
                    } catch (error) {
                        console.error('AI check failed:', error);
                        // Fallback to simple text matching
                        isCorrect = question.correct_options.some(correct => 
                            userAnswer.toLowerCase().includes(correct.toLowerCase())
                        );
                    }
                }
            }

            // Store answer and result
            userAnswers[currentQuestion] = userAnswer;
            examResults[currentQuestion] = {
                questionId: question.id,
                userAnswer: userAnswer,
                isCorrect: isCorrect,
                marks: isCorrect ? question.marks : 0,
                timeSpent: Date.now() - startTime
            };

            if (isCorrect) {
                score += question.marks;
            }

            // Show feedback
            showFeedback(question, userAnswer, isCorrect);
            
            // Update controls
            document.getElementById('submitButton').disabled = true;
            document.getElementById('aiButton').disabled = false;
            document.getElementById('nextButton').disabled = false;
            
            // Disable form inputs
            const inputs = form.querySelectorAll('input, textarea');
            inputs.forEach(input => input.disabled = true);
            
            updateProgress();
            
            // Save to database
            await saveAnswerToDatabase(currentQuestion, userAnswer, isCorrect);
        }

        // Show feedback for the current question
        function showFeedback(question, userAnswer, isCorrect) {
            const feedbackDiv = document.getElementById('answer-feedback');
            feedbackDiv.className = isCorrect ? 'feedback-correct' : 'feedback-incorrect';
            feedbackDiv.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                    <span class="feedback-icon">${isCorrect ? '✅' : '❌'}</span>
                    <span style="font-weight: bold; font-size: 1.2em;">
                        ${isCorrect ? 'Correct!' : 'Incorrect'}
                    </span>
                    <span style="margin-left: auto; font-weight: bold;">
                        +${isCorrect ? question.marks : 0} mark${question.marks > 1 ? 's' : ''}
                    </span>
                </div>
                <div style="line-height: 1.6;">
                    ${question.explanation}
                </div>
            `;
        }

        // AI Response function
        async function getAIResponse() {
            const question = examData.questions[currentQuestion];
            const responseBox = document.getElementById('ai-response');
            
            responseBox.style.display = 'block';
            responseBox.innerHTML = '<div class="loading"></div> Loading AI response...';

            try {
                const response = await fetch('/ask-ai', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        messages: [{
                            role: 'user',
                            content: `Please help me understand this Primary 4 Science question: ${question.question}. Provide hints and explanations but don't give the direct answer.`
                        }]
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                responseBox.innerHTML = `
                    <div class="ai-response-content">
                        <h4>🤖 AI Study Helper</h4>
                        <p>${data.response.replace(/\n/g, '<br>')}</p>
                    </div>
                    <div class="ai-hints">
                        💡 Use this information to help you think through the problem. Try to work out the answer yourself!
                    </div>
                `;
                
            } catch (error) {
                console.error('AI Response Error:', error);
                responseBox.innerHTML = `
                    <div style="color: #d32f2f; padding: 15px; background: #ffebee; border-radius: 8px;">
                        <strong>Error:</strong> ${error.message}
                        <button onclick="getAIResponse()" style="margin-left: 10px; padding: 5px 10px; background: #d32f2f; color: white; border: none; border-radius: 3px; cursor: pointer;">
                            Try Again
                        </button>
                    </div>
                `;
            }
        }

        // Check answer with AI for textbox questions
        async function checkAnswerWithAI(questionText, userAnswer, correctOptions) {
            try {
                const response = await fetch('/check-with-ai', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        question: questionText,
                        userAnswer: userAnswer,
                        correctOptions: correctOptions,
                        examId: examData.id,
                        questionNumber: currentQuestion + 1
                    })
                });

                const data = await response.json();
                return {
                    isCorrect: data.isCorrect || false,
                    explanation: data.explanation || 'Answer checked by AI.'
                };
            } catch (error) {
                console.error('AI check error:', error);
                return { isCorrect: false, explanation: 'Could not verify answer.' };
            }
        }

        // Save answer to database
        async function saveAnswerToDatabase(questionIndex, userAnswer, isCorrect) {
            try {
                const response = await fetch('/save-exam-answer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        examId: examData.id,
                        questionNumber: questionIndex + 1,
                        questionId: examData.questions[questionIndex].id,
                        userAnswer: userAnswer,
                        isCorrect: isCorrect,
                        marks: isCorrect ? examData.questions[questionIndex].marks : 0,
                        timeSpent: Math.round((Date.now() - startTime) / 1000)
                    })
                });

                const data = await response.json();
                if (!data.success) {
                    console.error('Failed to save answer:', data.error);
                }
            } catch (error) {
                console.error('Error saving answer:', error);
            }
        }

        // Navigation functions
        function nextQuestion() {
            if (currentQuestion < examData.totalQuestions - 1) {
                currentQuestion++;
                displayQuestion(currentQuestion);
                updateProgress();
                updateControls();
            } else {
                finishExam();
            }
        }

        function previousQuestion() {
            if (currentQuestion > 0) {
                currentQuestion--;
                displayQuestion(currentQuestion);
                updateProgress();
                updateControls();
            }
        }

        // Finish exam
        async function finishExam() {
            const totalMarks = examData.questions.reduce((sum, q) => sum + q.marks, 0);
            const percentage = Math.round((score / totalMarks) * 100);
            const timeTaken = Math.round((Date.now() - startTime) / 60000); // minutes

            // Save exam completion to database
            try {
                await fetch('/complete-exam', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        examId: examData.id,
                        totalScore: score,
                        maxScore: totalMarks,
                        percentage: percentage,
                        timeTaken: timeTaken,
                        results: examResults
                    })
                });
            } catch (error) {
                console.error('Error saving exam completion:', error);
            }

            // Redirect to results page
            window.location.href = `/exam-results/${examData.id}?score=${score}&total=${totalMarks}&percentage=${percentage}&time=${timeTaken}`;
        }

        // End exam early
        function endExam() {
            if (confirm('Are you sure you want to end the exam? Your current progress will be saved.')) {
                finishExam();
            }
        }

        // Show results (for debugging)
        function showResults() {
            console.log('Current Results:', {
                score: score,
                answers: userAnswers,
                results: examResults
            });
        }

        // Initialize exam when page loads
        window.onload = function() {
            initializeExam();
        };
    </script>
</body>
</html>
